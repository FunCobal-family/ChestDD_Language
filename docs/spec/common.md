# ChestDD 共通仕様書

## 序説

### 目的

- 機械可読性と人間可読性の両立: 読み書きの両面においてプログラムと人間の双方にとって扱いやすいものである
- 基礎的なデータ型への対応: 動的・静的問わず一般的なプログラミング言語が用意するデータ型をカバーする
- 豊富なデータ表現力: 基礎的なデータ型のほか、ありとあらゆる表現を構造的に、かつ明瞭に記述できる
- それ自身がスキーマともなることができ、追加のスキーマ言語を必要としない
- 可搬性と拡張性: プログラミング言語を含むあらゆる実体の間でデータを共有可能とするものであり、また使用するものによって適宜拡張できる
- 簡潔な仕様と実装容易性:

### 沿革

### 用語定義

歴史上全角・半角の区別がある文字については、特に明示しない限り半角であるものとする(ただし全角・半角の区別を支持するものではない)。

形式文法の定義は特に明示しない限りFCPEGによる(なおFCPEG自体、ChestDD言語(Gramsエディション)から派生した言語である)。各関係項目ごとに対応する定義を示すが、完全な形式文法は[別ファイル](./common.fcpeg)に収める。正規表現で示す場合、特に変種名を示さない限り鬼雲の文法に従うものとする。

なお、FCPEGによる基礎的な定義は以下の通りである。

```fcpeg
-- アラビア数字,
Digit <- [0-9],
-- 基本ラテン文字(小文字),
AlphaL <- [a-z],
-- 基本ラテン文字(大文字),
AlphaU <- [A-Z],
-- 基本ラテン文字,
Alpha <- AlphaL : AlphaU,
-- 基本ラテン文字及びアラビア数字,
AlphaNum <- Alpha : Digit,
-- 論理改行(物理改行のみ),
NL <- "\n\r" : "\n" : "\r",
-- 論理改行(物理改行又はカンマ),
CNL <- NL : "," " "?,
-- 論理改行(物理改行又はセミコロン),
SNL <- NL : ";" " "?,
```

## 概観

## エディション

基礎的なエディションであるコアエディションのほか、特定対象領域に特化したエディションが存在する。現在次の 9 エディションが存在する。エディション別の仕様は下記リンク先に記述するものとし、本文書は共通仕様を示す。エディションは今後追加される可能性がある。

- **エディション名\<略号>: 説明**
- Core\<core>: 汎用用途. 純粋な共通仕様のみによるエディション
- [Biblio\<bib>](./biblio.md): 書誌情報などメタ情報の列記
- [Streams\<str>](./streams.md): SNS 等の投稿データ
- [Pages\<page>](./pages.md): 記事や書籍などの各ページのデータ
- [Modules\<mod>](./modules.md): 学科目情報の記述
- [Conf\<cfg>](./conf.md): 各種システムの設定ファイルとして使用する
- [Grams\<gram>](./grams.md): 形式文法の定義ファイルとして使用する
- [Meta\<meta>](./meta.md): 個別の詳細メタ情報の記述
- [Graph\<grp>](./graph.md): グラフ構造の記述

### 拡張子

データ記述ファイルは`.csdd`(ChestDD)で、必要に応じて定義可能なスキーマ`.cpd`(ChestDD Prototype Definition)を用いる。追加された機能を持たせそのための処理系を用意する場合、データ記述ファイルのヘッダエリアとデータエリアを別ファイルとし、データエリアの拡張子をその仕様で定められたものとすることができる。なお、`.csdd`及び`.cpd`ファイルはその目的の違いを拡張子にて指示するのみで仕様上は何ら変わるところはない。

### ヘッダ行

ChestDDファイルは次のようなヘッダ行で開始する。ヘッダ行はシヴァン記号`#!`から始まり要素ごとに空白で分離されたパラメタ及びフラグを続ける。なお、記述するパラメタがない場合、ヘッダ行は必要ない。

- `-m`: モードを示すパラメタ。`nom`(一般)、`std`(標準)、`dbg`(デバッグ)があり、既定は`nom`。`std`は形式規格仕様においてのみ使用可能。
- `-d`: デフォルト読み込み指定を示すパラメタ。`all`(全部)、`partial`(部分的)があり、既定は`all`。その`.cpd`は`pair`シヴァンによる指定をしなくとも処理系にて自動で読み込まれる。`std`モードのときのみ使用可能。`partial`を指定した場合には、
- `-e`: エディションを示すパラメタ。エディション名(ChestDD Biblio では Biblio)の略号(同 bib)。記述しない場合はコアエディションとして処理される。
- `-v`: ChestDD のバージョンを示すパラメタ。バージョン記法を用いるほか、範囲として`|||`を、論理和として`&&&`を用いることができる。記述しない場合の挙動は処理系依存。

```csdd
#! -e bib -v ^0.0.0 &&& ^1.0.0
```

ChestDDファイルから他のChestDDファイルを読み込む場合は、これに続いて次のようなヘッダ行をもつ。ヘッダ行は同様のシヴァン記号から始まり要素ごとに空白で分離されたファイル読み込み指定句を続ける。

- "pair" \<cpdプロトタイプ名> on "\<ホスト種別>:\<ユーザ名>/\<レポジトリ名>:\<path/to/file.ext>"

```csdd
#! pair on "github:FanCobal_family/fcpeg:spec/csdd/"
```

また、語彙スキームを取り込みキーとして用いることができる。この場合pairと同様の記法を利用できる。

```csdd
#! use on "http://ndl.go.jp/dcndl/terms/" as dcndl
```

## データ型

型

### 型注釈

データ型は記述されたデータ型により自動的に推論されるが、型注釈を付けてデータ型を明示することが可能である。データの前に型注釈を置く前置スタイルとデータの後に型注釈を置く後置スタイルがある。原則としては後置スタイルによるものとするが、コレクション型の場合などにおいては前置スタイルを用いることが有意義であろう。

データ型は、独立なデータであるスカラ型と、複数のデータを纏めて一つのデータとするコレクション型に分けられる。また、スカラ型はそれのみによって表現する基本型と他の型をリテラル中に組み込む複合型に分けられる。

以下に示すほか、各々のエディションや使用者が独自にデータ型を定義し追加することができる。

### 基本型

#### 整数型 - int type

int \<: real

また用いる進数や格納するビット数も指定することができる。

#### 小数点数型 - ptr type

ptr \<: real

既定では浮動小数点数を表すが、別途指定することにより固定小数点数を示すこともできる。また用いる進数や格納するビット数も指定することができる。

#### 論理値型 - boolean type (bool type)

bool \<: obj

真として認識されるのは`true`, `yes`, `on`, `ja`, `yep`、偽として認識されるのは`false`, `no`, `off`, `ne`, `nop`である。

```fcpeg
Boolean <- TrueVal : FalseVal,
TrueVal <- "true" : "yes" : "on" : "ja" : "yep",
FalseVal <- "false" : "no" : "off" : "ne" : "nop",
```

#### 文字列型 - string type (str type)

引用符`"`によって挟まれる文字列の並びに加え、他のいかなる型にも含まれない文字列の並びは文字列型である。

#### バイナリ型 - binary type (bin type)

文字列にエンコードされたバイナリデータを表現する。Base64形式または16進数表現による。角括弧`<`及び`>`によって挟まれる。

### キーワード型 - keyword type

標準ラテン文字小文字ないし一部記号の並びによって表現される。加えて、空白を挟んだ後、任意のないし指定の型を持つデータを後続させることができる。ただし、次の制約による。

- 一文字目は一部記号を
- 空白を伴って

ここで、一部記号とは以下の通りとする。

- コロン`:`
- 感嘆符`!`
- ハイフン`-`
- アットマーク`@`
- アスタリスク`*`
- シャープ`#`
- バー`|`
- 開き括弧`(`/`[`/`<`/`{`
- 閉じ括弧`)`/`]`/`>`/`}`
コロン`:`以外の一部記号を一文字目として用いるものは型システムないし文書構造に関するChestDD言語の文法として予約されたものであり、一般にはユーザ定義できない。
以下のようにChestDD言語の文法として予約されたものもある。

`:keyword`
`!@typename obj` 型名(前置)
`obj @typename` 型名(後置)
`!type block` 型演算による型定義
`!proto block`
`!typedef block` データ構造やリテラル形式
`!---` 分離ストリーム
`-- text` 単行コメント
`{-- text --}` 複行コメント
`*anc obj`アンカー定義
`&anc`ノード参照
`<< [anc, anc, ...]`ノード統合
`:ns: obj` 名前空間の利用

### シンボル型 - symbol\<T\> type

symbol \<: obj

一重引用符に続く標準ラテン文字及びアラビア数字、アンダースコアの並びによって表現される。なお、一重引用符に続く最初の文字は標準ラテン文字でなければならない。型注釈にジェネリクスのつく場合にはその型に解決されるシンボルであることを意味し、この場合`symbol solved to T`型と示される。

```fcpeg
Symbol <- "'" Alpha (AlphaNum : "_")*,
```

`'symbol`

### 識別子型 - identifier\<T\> type (ident\<T\> type)

ident \<: obj

一重引用符に続く標準ラテン文字の並びによって表現される。型注釈にジェネリクスのつく場合にはその型に解決される識別子であることを意味する。

```fcpeg
Ident <- IdentA : IdentB : IdentC : IdentD,
IdentA <- ,
IdentB <- ,
IdentC <- ,
IdentD <- ,
```

`ident`

### 複合型

#### 数値型 - number type (num type)

num \<: obj

数値型は実数型と複素数型を部分集合として含む。

#### 実数型 - real type

real \<: num

実数型は整数型と小数点数型を部分集合として含む。

#### 複素数型 - complex\<T: (T \<: real\> type

complex \<: num

実部と虚部をアンダースコアで結合したものである。各数は実数型ないしシンボル型、式型である必要がある。虚数単位は`i`及び`j`の双方が許される。

`im_rei` または `im_rej`

i_type N = T|expr solved to T|symbol solved to T

- [re: N] 実部。省略時既定時は0又はその相当量
- [im: N] 虚部。省略時既定時は0又はその相当量

```fcpeg
Complex<T['reals]> <- T? "_" (T ("i" : "j"))?,
```

#### 座標点型 - point\<T: (T \<: num\> type

各軸の点を列記することにより、任意次元の座標点を表現することができる。各軸の数は数値型ないしシンボル型、式型である必要がある。

i_type N = T|expr solved to T|symbol solved to T

`:(x, y, ...)`

- x: N
- y: N
- ... (以降同様)

```fcpeg
Point<T['numbers]> <- ":(" (T ", ")* T ")",
```

#### 区間型 - range\<T: (T \<: num\> type

開始点と終了点の組により開区間ないし閉区間を表現する。間隔を指定することにより離散的な区間を表すことができる。開始点、終了点、間隔は数値型ないしシンボル型、式型である必要がある。

`:[min (-|+)?...(-|+)? max; itv]`

ここで`...`は更に列挙可能の意味ではなく区間型固有のリテラルである。また`itv`を省略する場合は`; `は必要ない。`...`の左右に`-`/`+`を示すことで開区間/閉区間を示すことができる。省略時規定値は閉区間。`...`の左にあるときminについて、右にあるときminについての言明である。

i_type N = T|expr solved to T|symbol solved to T

- [min: N] 最小値。省略時既定時は負の無限大又はその相当量
- [max: N] 最大値。省略時既定時は正の無限大又はその相当量
- [itv: N] 間隔。省略時既定時は連続集合のとき0、離散集合の時単位元(intの場合1、ptrの場合非零最小正値)
- \[`-`]: 開区間
- \[`+`]: 閉区間

```fcpeg
Range<T['numbers]> <- ":[" T? " " ("+" : "-")? "..." ("+" : "-")? " " T? ("; " T)? "]",
```

#### URI型 - uri type

標準規格[](https)によってフォーマットされた文字列として示される。また非引用符スタイルかつ単一行スタイルによる。文字列型ないしシンボル型、式型とのタプル型の場合、そのURIを示す文字列として認識される。

#### UUID型 - uuid type

標準規格[](https)によってフォーマットされた文字列として示される。また非引用符スタイルかつ単一行スタイルによる。

#### 関係型 - relation\<A,B\> type (rel\<A,B\> type)

矢印`->`で挟まれた二つのデータとして表現される。なお、矢印とデータの間は空白を挟む。文字列型ないしシンボル型、式型とのタプル型の場合、その関係の種別を示す標識として認識される。

```fcpeg
Relation<A, B> <- A "->" B,
```

#### 式型 - expression (expr type)

第一要素にシンボル型、第二要素以降に任意型を持つタプル型として定義される。第二要素以降にシンボル型と任意型との組型が現れる場合、名前付き引数と解釈されうる。その式を適用した結果がT型となる場合、`expr solved to T`型と示される。

#### 関数型 - function type (fun type)

第一要素にシンボル型、第二要素にタプル型、第三要素に式型のリスト型を持つタプル型として定義される。第二要素にシンボル型と任意型との組型が現れる場合、名前付き引数と解釈されうる。

### コレクション型

#### タプル型 - tuple

#### 組型 - pair\<K, V\>

鍵と値の組。

```fcpeg
Pair<K, V> <- K ": " V,
```

#### リスト型 - list\<E\>

#### 集合型 - set\<E\>

ユニークな値(同じ値が同一オブジェクト内に出現しない)による列挙可能コンテナ。並び順の不変性は保証されない。

#### ブロック型 - block\<T, E\>

タグの付いた列挙可能コンテナ。ブロック型という名称であるが実際には純粋なブロックではなく前置タグ付きブロックである。タグとなりうるのは大抵の場合文字列型、シンボル型、識別子型である。

```fcpeg
Block<T, E> <- "[" T "]{" (E CNL)* E CNL? "}",
```

#### 表型

### 型定義
